From ba85922e98e650e45a0f26c31d9f42bc16d2b4ac Mon Sep 17 00:00:00 2001
From: Yu Chien Peter Lin <peterlin@andestech.com>
Date: Tue, 5 Mar 2024 19:27:12 +0800
Subject: [PATCH 12/17] riscv: plat-virt: Enable semihosting

---
 core/arch/riscv/plat-virt/conf.mk |  7 +++++--
 core/arch/riscv/plat-virt/main.c  | 12 ------------
 2 files changed, 5 insertions(+), 14 deletions(-)

diff --git a/core/arch/riscv/plat-virt/conf.mk b/core/arch/riscv/plat-virt/conf.mk
index 90be7941f..16579b22d 100644
--- a/core/arch/riscv/plat-virt/conf.mk
+++ b/core/arch/riscv/plat-virt/conf.mk
@@ -28,8 +28,11 @@ rv64-platform-isa ?= rv64imafdc_zicsr_zifencei
 $(call force,CFG_RISCV_M_MODE,n)
 $(call force,CFG_RISCV_S_MODE,y)
 $(call force,CFG_RISCV_PLIC,n)
-$(call force,CFG_SBI_CONSOLE,n)
-$(call force,CFG_16550_UART,y)
+$(call force,CFG_RISCV_SBI_CONSOLE,n)
+$(call force,CFG_16550_UART,n)
+$(call force,CFG_SEMIHOSTING,y)
+$(call force,CFG_SEMIHOSTING_CONSOLE,y)
+CFG_SEMIHOSTING_CONSOLE_FILE ?= NULL
 $(call force,CFG_RISCV_TIME_SOURCE_RDTIME,y)
 CFG_RISCV_MTIME_RATE ?= 10000000
 CFG_RISCV_SBI ?= y
diff --git a/core/arch/riscv/plat-virt/main.c b/core/arch/riscv/plat-virt/main.c
index f6f6120d1..ebd496207 100644
--- a/core/arch/riscv/plat-virt/main.c
+++ b/core/arch/riscv/plat-virt/main.c
@@ -4,19 +4,13 @@
  */
 
 #include <console.h>
-#include <drivers/ns16550.h>
 #include <drivers/plic.h>
 #include <kernel/boot.h>
 #include <kernel/tee_common_otp.h>
 #include <platform_config.h>
 
-static struct ns16550_data console_data __nex_bss;
-
 register_ddr(DRAM_BASE, DRAM_SIZE);
 
-register_phys_mem_pgdir(MEM_AREA_IO_NSEC, UART0_BASE,
-			CORE_MMU_PGDIR_SIZE);
-
 #ifdef CFG_RISCV_PLIC
 void boot_primary_init_intc(void)
 {
@@ -29,12 +23,6 @@ void boot_secondary_init_intc(void)
 }
 #endif /* CFG_RISCV_PLIC */
 
-void plat_console_init(void)
-{
-	ns16550_init(&console_data, UART0_BASE, IO_WIDTH_U8, 0);
-	register_serial_console(&console_data.chip);
-}
-
 void interrupt_main_handler(void)
 {
 	if (IS_ENABLED(CFG_RISCV_PLIC))
-- 
2.34.1

