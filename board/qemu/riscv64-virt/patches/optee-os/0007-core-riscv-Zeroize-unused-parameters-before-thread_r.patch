From 8fe698d5854d5378839342b8c6aaed3c0293ec19 Mon Sep 17 00:00:00 2001
From: Alvin Chang <alvinga@andestech.com>
Date: Tue, 5 Mar 2024 17:12:13 +0800
Subject: [PATCH 07/17] core: riscv: Zeroize unused parameters before
 thread_return_to_udomain()

Signed-off-by: Alvin Chang <alvinga@andestech.com>
Reviewed-by: Yu Chien Peter Lin <peterlin@andestech.com>
---
 core/arch/riscv/kernel/entry.S               | 9 +++++++++
 core/arch/riscv/kernel/thread_optee_abi_rv.S | 8 ++++++++
 core/arch/riscv/kernel/thread_rv.S           | 5 +++--
 3 files changed, 20 insertions(+), 2 deletions(-)

diff --git a/core/arch/riscv/kernel/entry.S b/core/arch/riscv/kernel/entry.S
index b4d65fe21..66b8bc57c 100644
--- a/core/arch/riscv/kernel/entry.S
+++ b/core/arch/riscv/kernel/entry.S
@@ -242,6 +242,10 @@ UNWIND(	.cantunwind)
 
 	li	a0, TEEABI_OPTEED_RETURN_ENTRY_DONE
 	la	a1, thread_vector_table
+	mv	a2, zero
+	mv	a3, zero
+	mv	a4, zero
+	mv	a5, zero
 	j	thread_return_to_udomain
 END_FUNC reset_primary
 
@@ -258,6 +262,11 @@ UNWIND(	.cantunwind)
 #ifdef CFG_RISCV_WITH_M_MODE_SM
 	/* Return to untrusted domain */
 	li	a0, TEEABI_OPTEED_RETURN_ON_DONE
+	mv	a1, zero
+	mv	a2, zero
+	mv	a3, zero
+	mv	a4, zero
+	mv	a5, zero
 	j	thread_return_to_udomain
 #endif
 	j	.
diff --git a/core/arch/riscv/kernel/thread_optee_abi_rv.S b/core/arch/riscv/kernel/thread_optee_abi_rv.S
index 643861a8d..ea114284a 100644
--- a/core/arch/riscv/kernel/thread_optee_abi_rv.S
+++ b/core/arch/riscv/kernel/thread_optee_abi_rv.S
@@ -65,6 +65,7 @@ FUNC thread_std_abi_entry , :
 	li	a3, 0
 	li	a4, 0
 	li	a0, TEEABI_OPTEED_RETURN_CALL_DONE
+	mv	a5, zero
 
 	/* Return to untrusted domain */
 	jal	thread_return_to_udomain
@@ -127,6 +128,7 @@ FUNC thread_rpc_xstatus , :
 	mv	a2, s3	/* rv[1] */
 	mv	a3, s4	/* rv[2] */
 	li	a0, TEEABI_OPTEED_RETURN_CALL_DONE
+	mv	a5, zero
 
 	/* Return to untrusted domain */
 	jal	thread_return_to_udomain
@@ -172,6 +174,7 @@ LOCAL_FUNC vector_std_abi_entry, : , .identity_map
 	li	a3, 0
 	li	a4, 0
 	li	a0, TEEABI_OPTEED_RETURN_CALL_DONE
+	mv	a5, zero
 
 	/* Return to untrusted domain */
 	j	thread_return_to_udomain
@@ -195,6 +198,11 @@ LOCAL_FUNC vector_fiq_entry , : , .identity_map
 	jal	interrupt_main_handler
 
 	li	a0, TEEABI_OPTEED_RETURN_FIQ_DONE
+	mv	a1, zero
+	mv	a2, zero
+	mv	a3, zero
+	mv	a4, zero
+	mv	a5, zero
 	/* Return to untrusted domain */
 	j	thread_return_to_udomain
 END_FUNC vector_fiq_entry
diff --git a/core/arch/riscv/kernel/thread_rv.S b/core/arch/riscv/kernel/thread_rv.S
index f03127870..f8cb76a5b 100644
--- a/core/arch/riscv/kernel/thread_rv.S
+++ b/core/arch/riscv/kernel/thread_rv.S
@@ -401,7 +401,8 @@ FUNC thread_foreign_interrupt_handler , :
 	mv	a4, a0
 	li	a0, TEEABI_OPTEED_RETURN_CALL_DONE
 	li	a1, OPTEE_ABI_RETURN_RPC_FOREIGN_INTR
-	mv	a2, x0
-	mv	a3, x0
+	mv	a2, zero
+	mv	a3, zero
+	mv	a5, zero
 	j	thread_return_to_udomain
 END_FUNC thread_foreign_interrupt_handler
-- 
2.34.1

