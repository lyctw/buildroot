From 015ecfdf43c1c0ce9aed18cc35919c95783038e5 Mon Sep 17 00:00:00 2001
From: Yu Chien Peter Lin <peterlin@andestech.com>
Date: Wed, 15 May 2024 20:03:13 +0800
Subject: [PATCH 17/17] riscv: plat-virt: switch to dynamic shared memory

Enable dynamic shared memory for QEMU virt machine.

Signed-off-by: Yu Chien Peter Lin <peterlin@andestech.com>
Reviewed-by: Alvin Chang <alvinga@andestech.com>
Acked-by: Jerome Forissier <jerome.forissier@linaro.org>
---
 core/arch/riscv/kernel/boot.c     | 1 +
 core/arch/riscv/plat-virt/conf.mk | 6 ++----
 2 files changed, 3 insertions(+), 4 deletions(-)

diff --git a/core/arch/riscv/kernel/boot.c b/core/arch/riscv/kernel/boot.c
index d4e606f07..7f4ef7b4d 100644
--- a/core/arch/riscv/kernel/boot.c
+++ b/core/arch/riscv/kernel/boot.c
@@ -193,6 +193,7 @@ void boot_init_primary_late(unsigned long fdt,
 			    unsigned long tos_fw_config __unused)
 {
 	init_external_dt(fdt, CFG_DTB_MAX_SIZE);
+	discover_nsec_memory();
 	update_external_dt();
 
 	IMSG("OP-TEE version: %s", core_v_str);
diff --git a/core/arch/riscv/plat-virt/conf.mk b/core/arch/riscv/plat-virt/conf.mk
index 381d5f627..ac724f864 100644
--- a/core/arch/riscv/plat-virt/conf.mk
+++ b/core/arch/riscv/plat-virt/conf.mk
@@ -2,7 +2,8 @@ $(call force,CFG_RV64_core,y)
 
 $(call force,CFG_CORE_LARGE_PHYS_ADDR,y)
 $(call force,CFG_TEE_CORE_DEBUG,n)
-$(call force,CFG_CORE_DYN_SHM,n)
+$(call force,CFG_CORE_RESERVED_SHM,n)
+$(call force,CFG_CORE_DYN_SHM,y)
 
 CFG_DT ?= y
 
@@ -44,7 +45,4 @@ supported-ta-targets = ta_rv64
 # Memory layout flags
 CFG_TDDRAM_START ?= 0xF1000000
 CFG_TDDRAM_SIZE  ?= 0x01000000
-$(call force,CFG_CORE_RESERVED_SHM,y)
-CFG_SHMEM_START  ?= 0xF2000000
-CFG_SHMEM_SIZE   ?= 0x00200000
 CFG_TEE_RAM_VA_SIZE ?= 0x00200000
-- 
2.34.1

